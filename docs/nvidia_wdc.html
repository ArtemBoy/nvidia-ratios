<!DOCTYPE html>
<html>
<head>
  <title>Nvidia Full Financials Data WDC</title>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/tableauwdc/2.3.0/tableauwdc.min.js"></script>
</head>
<body>
  <h2>Click the button to load Nvidia Full Financials Data</h2>
  <button id="loadButton">Load Data</button>

  <script>
    (function () {
      const connector = tableau.makeConnector();

      connector.getSchema = function (schemaCallback) {
        fetch("https://artemboy.github.io/nvidia-ratios/data/nvidia_full_data.csv")
          .then(response => response.text())
          .then(text => {
            const lines = text.split("\n").filter(line => line.trim() !== "");
            const headers = lines[0].split(",");
            const cols = headers.map(col => ({
              id: col.trim().replace(/\W/g, "_"),  // sanitize for Tableau
              dataType: tableau.dataTypeEnum.string
            }));

            schemaCallback([{
              id: "nvidia_full_data",
              alias: "Nvidia Full Financials",
              columns: cols
            }]);
          })
          .catch(error => tableau.abortWithError("Schema load error: " + error));
      };

      connector.getData = function (table, doneCallback) {
        fetch("https://artemboy.github.io/nvidia-ratios/data/nvidia_full_data.csv")
          .then(response => response.text())
          .then(text => {
            const lines = text.split("\n").filter(line => line.trim() !== "");
            const headers = lines[0].split(",");
            const data = lines.slice(1).map(line => {
              const values = line.split(",");
              const row = {};
              headers.forEach((header, i) => {
                row[header.trim().replace(/\W/g, "_")] = values[i]?.trim();
              });
              return row;
            });

            table.appendRows(data);
            doneCallback();
          })
          .catch(error => tableau.abortWithError("Data fetch error: " + error));
      };

      tableau.registerConnector(connector);

      document.getElementById("loadButton").addEventListener("click", function () {
        tableau.connectionName = "Nvidia Full Financials Data";
        tableau.submit();
      });
    })();
  </script>
</body>
</html>
