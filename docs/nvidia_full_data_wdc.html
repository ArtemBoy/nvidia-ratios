<!DOCTYPE html>
<html>
<head>
  <title>Nvidia Full Financials Data WDC</title>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/tableauwdc/2.3.0/tableauwdc.min.js"></script>
</head>
<body>
  <h2>Click the button to load Nvidia Full Financials Data</h2>
  <button id="loadButton">Load Data</button>

  <script>
    (function () {
      const connector = tableau.makeConnector();
      let sanitizedHeaders = [];

      connector.getSchema = function (schemaCallback) {
        fetch("https://artemboy.github.io/nvidia-ratios/data/nvidia_full_data.csv")
          .then(response => response.text())
          .then(text => {
            const lines = text.split("\n").filter(line => line.trim() !== "");
            const rawHeaders = lines[0].split(",");
            sanitizedHeaders = rawHeaders.map(h => h.trim().replace(/[^\w]/g, "_"));

            const cols = sanitizedHeaders.map(col => ({
              id: col,
              dataType: tableau.dataTypeEnum.string
            }));

            schemaCallback([{
              id: "nvidia_full_data",
              alias: "Nvidia Full Financials",
              columns: cols
            }]);
          })
          .catch(error => tableau.abortWithError("Schema load error: " + error));
      };

      connector.getData = function (table, doneCallback) {
        fetch("https://artemboy.github.io/nvidia-ratios/data/nvidia_full_data.csv")
          .then(response => response.text())
          .then(text => {
            const lines = text.split("\n").filter(line => line.trim() !== "");
            const rawHeaders = lines[0].split(",");

            const data = lines.slice(1).map(line => {
              const values = line.split(",");
              const row = {};
              rawHeaders.forEach((header, i) => {
                const cleanHeader = header.trim().replace(/[^\w]/g, "_");
                row[cleanHeader] = values[i]?.trim();
              });
              return row;
            });

            table.appendRows(data);
            doneCallback();
          })
          .catch(error => tableau.abortWithError("Data fetch error: " + error));
      };

      tableau.registerConnector(connector);

      document.getElementById("loadButton").addEventListener("click", function () {
        tableau.connectionName = "Nvidia Full Financials Data";
        tableau.submit();
      });
    })();
  </script>
</body>
</html>
